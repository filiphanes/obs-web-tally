<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no, shrink-to-fit=no" />
	<meta name="HandheldFriendly" content="true">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<link rel="apple-touch-icon" sizes="57x57" href="img/fav/apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="img/fav/apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="img/fav/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="img/fav/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="img/fav/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="img/fav/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="img/fav/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="img/fav/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="img/fav/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192" href="img/fav/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="img/fav/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="img/fav/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="img/fav/favicon-16x16.png">
	<link rel="manifest" href="manifest.json">
	<meta name="theme-color" content="#000">
	<script src="NoSleep.js"></script>
	<title>OBS Tally</title>

<style>
* {
	box-sizing: border-box;
	-moz-box-sizing: border-box;
	-ms-box-sizing: border-box;
	-webkit-box-sizing: border-box;
	-khtml-box-sizing: border-box;
	outline: 0;
	-webkit-user-select: none;
	-ms-user-select: none;
	user-select: none;
	margin: 0;
	padding: 0;
}

body {
	text-align: center;
	background-color: black;
	color: #eee;
	font-weight: 300;
	font-family: sans-serif;
	font-size: 20px;
	position: absolute;
	top: 0;
	left: 0;
	bottom: 0;
	right: 0;
	overflow: scroll;
	display: flex;
	align-items: center;
	justify-content: center;
}

button {
	user-select: initial;
	appearance: none;
	background-color: #707070;
	color: black;
	padding: 1rem 0;
	border-radius: 0.5rem;
	overflow: hidden;
	font-size: 1.2rem;
	margin: .5rem;
	width: 4rem;
	border: none;
	text-align: center;
}

input[type='text'] {
	padding: 1rem;
	font-size: 1.2rem;
	border: 0;
	background: #707070;
	border-radius: .5rem;
	margin: 1rem .5rem 0;
}

#pageSelect,
#pageTally {
	display: none;
	flex-wrap: wrap;
	align-items: center;
	justify-content: center;
	flex: 1;
	max-width: 90%;
}

#pageTally {
	align-self: stretch;
	font-weight: bold;
	max-width: 100%;
}

#tally_id,
#tally_img {
	flex: 1 0 100%;
}

#tally_img{
	display: none;
}
#tally_id {
	font-size: 7rem;
}

#tally_img .w19_frame {
	background-color: black;
}

.w19_frame {
	width: 100%;
	list-style: none;
	text-align: left;
	overflow: hidden;
	background-size: cover;
	background-repeat: no-repeat;
	background-position: center center;
	position: relative;
	padding-bottom: 56.25%;
	margin-bottom: 1rem;
}

.w19_frame .w19_box {
	position: absolute;
	top: 0;
	left: 0;
	margin: 0px;
	padding: 0px;
	width: 100% !important;
	height: 100% !important;
}

.w19_box img {
	display: block;
	width: 100%;
	height: auto;
}

body.pageSelect #pageSelect,
body.pageTally #pageTally {
	display: flex;
}

body.inPreview{
	background-color: #97da49;
	color: black;
}
body.inProgram{
	background-color: #ff0000;
	color: black;
}

@media screen and (min-width: 560px) {
	#tally_id { flex: 1 0 35%; }
	#tally_img { flex: 1 0 50%; }
	#pageTally { padding: 0 1rem; }
}

.switch {
	margin: 1rem 0 0;
	width: 100%;
}

.switch input { 
  width: 2rem;
  height: 2rem;
  vertical-align: middle;
}

body.showScreen #tally_img{
	display: block;
}
	</style>
	</head>

	<body class="pageSelect">
		<div id="pageSelect">
			<button onclick="select(1);">T1</button>
			<button onclick="select(2);">T2</button>
			<button onclick="select(3);">T3</button>
			<button onclick="select(4);">T4</button>
			<button onclick="select(5);">T5</button>
			<button onclick="select(6);">T6</button>
			<button onclick="select(7);">T7</button>
			<button onclick="select(8);">T8</button>
			<button onclick="select(9);">T9</button>
			<button onclick="select(10);">T10</button>
			<button onclick="select(11);">T11</button>
			<button onclick="select(12);">T12</button>
			<label class="switch"><input type="checkbox" id="showScreen"> screenshot</label>
			<input type="text" id="name" placeholder="Name" value="Name"/>
			<input type="text" id="wsUrl" placeholder="WebSocket host:port" value="192.168.1.2:4455"/>
		</div>
		<div id="pageTally">
			<span id="sceneName" onclick="enterFullscreen();"></span>
			<span id="tally_id">0</span>
			<div id="tally_img">
				<div class="w19_frame">
					<div class="w19_box">
						<img id="program" alt="" src="">
					</div>
				</div>
				<span id="screenSceneName"></span>
			</div>
		</div>
	</body>

<script>
function storageAvailable(type) {
  var storage;
  try {
    storage = window[type];
    var x = '__storage_test__';
    storage.setItem(x, x);
    storage.removeItem(x);
    return true;
  } catch (e) {
    return e instanceof DOMException && (
      // everything except Firefox
      e.code === 22 ||
      // Firefox
      e.code === 1014 ||
      // test name field too, because code might not be present
      // everything except Firefox
      e.name === 'QuotaExceededError' ||
      // Firefox
      e.name === 'NS_ERROR_DOM_QUOTA_REACHED') &&
      // acknowledge QuotaExceededError only if there's something already stored
      (storage && storage.length !== 0);
  }
}

var storage = storageAvailable('localStorage') ? localStorage : {};
let socketServer = storage["socketServer"] || "192.168.2.18:4455";
document.getElementById("wsUrl").value = socketServer;
const sceneName = document.getElementById("sceneName");
const screenSceneName = document.getElementById("screenSceneName");
let screenshotInterval = false;
let screenshotScene = "";
let screenshotPayload = false;
let reconnectInterval = false;
let nosleep = new NoSleep();
let tallyId = 0;
let tallyRegex = null;
let fullScreen = false;

document.addEventListener("visibilitychange", function() {
  if (document.visibilityState === 'visible') {
		// connectWebsocket();
  } else {  // hidden
  	nosleep.disable();
  }
});

function setBodyClass(name, yes) {
	if (yes) {
		document.body.classList.add(name);
	} else {
		document.body.classList.remove(name);
	}
}

function updateScreenshot() {
	if (screenshotPayload && websocket.readyState == 1) {
		console.log("Requesting screenshot");
		websocket.send(screenshotPayload);
	}
}

function setScreenshotScene(name) {
	if (screenshotScene != name && screenshotInterval) {
		screenshotScene = name;
		screenSceneName.innerText = name;
		screenshotPayload = JSON.stringify({
			"op": 6,
			"d": {
				"requestType": "GetSourceScreenshot",
				"requestId": "GetSourceScreenshot",
				"requestData": {
					"sourceName": name,
					"imageFormat": 'jpeg',
					"imageWidth": 360,
					"imageCompressionQuality": 80,
				}
			}
		});
		setTimeout(updateScreenshot, 50);
	}
}

async function parseMessage(data) {
	if (!data.hasOwnProperty("op")) return;
	var op = data.op;
	if (op==0) {
		// TODO: if (data.d.authentication) { base64(sha256(base64(sha256(password.value + data.d.authentication.salt)) + data.d.authentication.challenge); }
		websocket.send(JSON.stringify({"op":1,"d":{"rpcVersion":1}}));
		return;
	}
	
	else if (op==2) {
		console.log("Handshaked");
		if (tallyRegex) {
			document.body.classList.remove("pageSelect");
			document.body.classList.add("pageTally");
			websocket.send(JSON.stringify({
				"op": 6,
				"d": {
					"requestType": "GetCurrentProgramScene",
					"requestId": "GetCurrentProgramScene",
					"requestData": {}
				}
			}));
			websocket.send(JSON.stringify({
				"op": 6,
				"d": {
					"requestType": "GetCurrentProgramScene",
					"requestId": "GetCurrentProgramScene",
					"requestData": {}
				}
			}));
			websocket.send(JSON.stringify({
				"op": 6,
				"d": {
					"requestType": "BroadcastCustomEvent",
					"requestId": "b",
					"requestData": {
						"type": "tally",
						"name": document.getElementById("name").value,
					}
				}
			}));
			return;
		}
	}
	
	else if (op==7) {
		if (!data.d.hasOwnProperty("requestType")) return;
		if (data.d.requestType == "GetCurrentProgramScene"){
			data.d.eventType = "CurrentProgramSceneChanged";
			data.d.eventData = {"sceneName": data.d.responseData.currentProgramSceneName};
			op=5;
		}
		else if (data.d.requestType == "GetCurrentPreviewScene" ){
			data.d.eventType = "CurrentPreviewSceneChanged";
			data.d.eventData = {"sceneName": data.d.responseData.currentPreviewSceneName};
			op=5;
		}
		else if (data.d.requestType == "GetSourceScreenshot" ){
			document.getElementById('program').src = data.d.responseData.imageData;
			return;
		}
	}

	if (op==5) {
		if (!data.d.hasOwnProperty("eventType")) return;
		const eventType = data.d.eventType;

		if (eventType == "CurrentProgramSceneChanged") {
			if (data.d.eventData.sceneName.search(tallyRegex) >= 0) {
				setBodyClass("inProgram", true);
				sceneName.innerText = data.d.eventData.sceneName;
			} else  {
				setBodyClass("inProgram", false);
				setScreenshotScene(data.d.eventData.sceneName);
			}
		}
		
		else if (eventType == "CurrentPreviewSceneChanged") {
			if (data.d.eventData.sceneName.search(tallyRegex) >= 0) {
				setBodyClass("inPreview", true);
				if (!document.body.classList.contains("inProgram")) {
					sceneName.innerText = data.d.eventData.sceneName;
				}
			} else {
				setBodyClass("inPreview", false);
				if (document.body.classList.contains("inProgram")) {
					setScreenshotScene(data.d.eventData.sceneName);
				}
			}
		}
		
		else if (eventType == "SceneTransitionStarted") {
			if (document.body.classList.contains("inPreview")) {
				setBodyClass("inProgram", true);
			}
		}

		else if (eventType == "SceneTransitionEnded") {
			if (document.body.classList.contains("inPreview")) {
				setBodyClass("inProgram", false);
			}
		}
	}
}

function select(id) {
	tallyId = id;
	tallyRegex = new RegExp(`\\bT${tallyId}\\b`);
	connectWebsocket();
	document.getElementById("tally_id").innerText = tallyId;
	nosleep.enable();
	if (document.getElementById("showScreen").checked) {
		document.body.classList.add("showScreen");
		screenshotInterval = setInterval(updateScreenshot, 3000);
	} else {
		document.body.classList.remove("showScreen");
		clearInterval(screenshotInterval);
		screenshotInterval = false;
	}
}

function connectWebsocket() {
	document.body.classList.add("connecting_");
	socketServer = document.getElementById("wsUrl").value;
	storage.setItem("socketServer", socketServer);
	console.log("socketServer:", socketServer);
	websocket = new WebSocket("ws://" + socketServer);
	//console.log( websocket );
	websocket.onopen = function(evt) {
		console.log("Socket open");
		document.body.classList.remove("connecting_");
		clearInterval(reconnectInterval);
		reconnectInterval = false;
	};

	websocket.onmessage = function(evt) {
		//console.log(evt);
		parseMessage(JSON.parse(evt.data));
	};

	websocket.onclose = function(evt) {
		console.log("Socket close");
		if (!reconnectInterval) {
			reconnectInterval = setInterval(connectWebsocket, 3000);
		}
	};

	websocket.onerror = function(evt) {
		console.log("Socket error");
		if (!reconnectInterval) {
			reconnectInterval = setInterval(connectWebsocket, 3000);
		}
	};

	return false;
}

function enterFullscreen() {
	var elem = document.documentElement;
	/* View in fullscreen */
	if (fullScreen) {
		fullScreen = false;
		if (document.exitFullscreen) {
			document.exitFullscreen();
		} else if (document.webkitExitFullscreen) { /* Safari */
			document.webkitExitFullscreen();
		} else if (document.msExitFullscreen) { /* IE11 */
			document.msExitFullscreen();
		}
	} else {
		fullScreen = true;
		if (elem.requestFullscreen) {
			elem.requestFullscreen();
		} else if (elem.webkitRequestFullscreen) { /* Safari */
			elem.webkitRequestFullscreen();
		} else if (elem.msRequestFullscreen) { /* IE11 */
			elem.msRequestFullscreen();
		}
	}
}
</script>
</html>